var getCookie = require('./getCookie.js');
var lang = getCookie('org.springframework.web.servlet.i18n.CookieLocaleResolver.LOCALE');

require('./libs/bootstrap.min.js');
require('./libs/FV/formValidation.min.js');
require('./libs/FV/bootstrap.min.js');
require('./libs/FV/i18n.min.js');
require('./libs/summernote/summernote.min.js');
require('./ck_lang.js');
require('./ck_ajax_setup.js');


require('bootstrap-datepicker/dist/js/bootstrap-datepicker.js');

$(document).ready(function() {

    var $dateRange = $('#newBulletinForm').find('.input-daterange');
    var $form = $('#newBulletinForm');

    $dateRange
    .datepicker({
        format: "yyyy/mm/dd",
        todayHighlight: true,
        todayBtn: true
    })
    .on('changeDate', function() {
        $form.formValidation('revalidateField', 'f-date');
    });

    $form
    .formValidation({
        framework: 'bootstrap',
        excluded: [':disabled'],
        icon: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        addOns: {
            i18n:{}
        },
        fields: {
            'role': {
                selector: '#newBulletinForm .f-role',
                validators: {
                    notEmpty: {
                        message: {
                            en_US: 'Role select can not be empty',
                            zh_CN: '角色选择不能为空'
                        }
                    },
                }
            },
            'title': {
                selector: '#newBulletinForm .f-title',
                validators: {
                    notEmpty: {
                        message: {
                            en_US: 'Title can not be empty',
                            zh_CN: '公告标题不能为空'
                        }
                    },
                    stringLength: {
                        min: 6,
                        max: 100,
                        message: {
                            en_US: 'The title length more than %s, but less than %s',
                            zh_CN: '标题长度大于6但是小于100'
                        }
                    },
                }
            },
            "f-date": {
                selector: '#newBulletinForm .f-date',
                validators: {
                    notEmpty: {
                        message: {
                            en_US: 'Time can not be empty',
                            zh_CN: '有效期不能为空'
                        }
                    },
                    date: {
                        format: 'YYYY/MM/DD',
                        message: __('Not a valid date')
                    }
                }
            },
            'content': {
                selector: '#newBulletinForm .content',
                validators: {
                    notEmpty: {
                        message: {
                            en_US: 'Title can not be empty',
                            zh_CN: '公告标题不能为空'
                        }
                    },
                    callback: {
                        message: {
                            en_US: 'The content can not be empty',
                            zh_CN: '内容不能为空'
                        },
                        callback: function(value, validator, $field) {
                            var code = $('#newBulletinForm').find('.content').val();
                            // <p><br></p> is code generated by Summernote for empty content
                            return (code !== '' && code !== '<p><br></p>');
                        }
                    }
                }
            }
        }
    })
    .find('.content')
    .summernote({
        height: 400,// set editor height
        minHeight: null,             // set minimum height of editor
        maxHeight: null,             // set maximum height of editor
        focus: true,                 // set focus to editable area after initializing summernote
    })
    .end()
    .on('summernote.change', function(customEvent, contents, $editable) {
        // Revalidate the content when its value is changed by Summernote
        $('#newBulletinForm').formValidation('revalidateField', 'content');
    })
    .on('err.validator.fv', function(e, data) {
        data.element
            .data('fv.messages')
            .find('.help-block[data-fv-for="' + data.field + '"]').hide()
            .filter('[data-fv-validator="' + data.validator + '"]').show();
    });
    $('#newBulletinForm').formValidation('setLocale', lang);
});